<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Qibla Compass</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A0E17">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Qibla">
<link rel="apple-touch-icon" href="icons/icon-152x152.png">
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512x512.png">

<meta name="description" content="Find the Qibla direction from anywhere using your phone's compass and GPS">
<meta property="og:title" content="Qibla Compass">
<meta property="og:description" content="Beautiful Qibla finder with live compass, map, and great circle path to Makkah">
<meta property="og:type" content="website">

<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<style>
  :root {
    --gold: #C9A84C;
    --gold-light: #E8D48B;
    --gold-dark: #8B6914;
    --bg-deep: #0A0E17;
    --bg-card: #111827;
    --text-primary: #F0EDE6;
    --text-muted: #8896AB;
    --emerald: #2DD4A8;
    --emerald-dark: #0D9373;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-deep);
    color: var(--text-primary);
    min-height: 100dvh;
    display: flex; flex-direction: column; align-items: center;
    overflow-x: hidden; overflow-y: auto;
    position: relative;
    overscroll-behavior: none;
  }

  body::before {
    content: ''; position: fixed; inset: 0;
    background:
      radial-gradient(1px 1px at 10% 20%, rgba(201,168,76,0.4), transparent),
      radial-gradient(1px 1px at 30% 65%, rgba(201,168,76,0.3), transparent),
      radial-gradient(1px 1px at 50% 10%, rgba(255,255,255,0.3), transparent),
      radial-gradient(1px 1px at 70% 40%, rgba(201,168,76,0.2), transparent),
      radial-gradient(1px 1px at 90% 80%, rgba(255,255,255,0.2), transparent),
      radial-gradient(1.5px 1.5px at 15% 85%, rgba(201,168,76,0.5), transparent),
      radial-gradient(1px 1px at 45% 45%, rgba(255,255,255,0.2), transparent),
      radial-gradient(1px 1px at 80% 15%, rgba(201,168,76,0.3), transparent),
      radial-gradient(1.5px 1.5px at 60% 90%, rgba(255,255,255,0.3), transparent),
      radial-gradient(1px 1px at 25% 35%, rgba(201,168,76,0.2), transparent);
    z-index: 0; pointer-events: none;
  }

  body::after {
    content: ''; position: fixed; top: 30%; left: 50%; transform: translate(-50%,-50%);
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(201,168,76,0.06) 0%, transparent 70%);
    z-index: 0; pointer-events: none;
  }

  .app {
    position: relative; z-index: 1; width: 100%; max-width: 420px;
    display: flex; flex-direction: column; align-items: center;
    padding: 20px 16px 32px;
    padding-top: max(20px, env(safe-area-inset-top));
    padding-bottom: max(32px, env(safe-area-inset-bottom));
    gap: 4px;
  }

  .header { text-align: center; }
  .header h1 { font-family: 'Amiri', serif; font-size: 26px; font-weight: 700; color: var(--gold); letter-spacing: 1px; }
  .header .arabic-title { font-family: 'Amiri', serif; font-size: 18px; color: var(--gold-light); opacity: 0.7; margin-top: -2px; }

  .status-bar {
    display: flex; align-items: center; gap: 8px; margin: 8px 0;
    padding: 6px 14px; background: rgba(255,255,255,0.04);
    border: 1px solid rgba(201,168,76,0.15); border-radius: 100px;
    font-size: 12px; color: var(--text-muted);
  }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text-muted); transition: background 0.4s; flex-shrink: 0; }
  .status-dot.active { background: var(--emerald); box-shadow: 0 0 8px rgba(45,212,168,0.5); }
  .status-dot.error { background: #E5484D; }

  /* ‚îÄ‚îÄ Compass ‚îÄ‚îÄ */
  .compass-wrapper { position: relative; width: 280px; height: 280px; flex-shrink: 0; }
  .compass-ring { position: absolute; inset: 0; border-radius: 50%; border: 1.5px solid rgba(201,168,76,0.25); transition: border-color 0.5s, box-shadow 0.5s; }
  .compass-ring.aligned { border-color: var(--emerald); box-shadow: 0 0 30px rgba(45,212,168,0.15); }
  .compass-inner {
    position: absolute; inset: 10px; border-radius: 50%;
    background: radial-gradient(circle at 40% 35%, rgba(25,35,55,0.9), rgba(10,14,23,0.95));
    border: 1px solid rgba(201,168,76,0.12); overflow: hidden;
  }
  .compass-inner::before { content: ''; position: absolute; inset: 0; background: repeating-conic-gradient(from 0deg, transparent 0deg 10deg, rgba(201,168,76,0.02) 10deg 20deg); border-radius: 50%; }
  .compass-plate { position: absolute; inset: 18px; transition: transform 0.12s ease-out; }
  .compass-plate svg { width: 100%; height: 100%; }
  .qibla-indicator { position: absolute; inset: 4px; transition: transform 0.12s ease-out; pointer-events: none; }
  .qibla-arrow { position: absolute; top: 6px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; filter: drop-shadow(0 0 12px rgba(201,168,76,0.6)); }
  .qibla-arrow .kaaba-icon { font-size: 20px; line-height: 1; }
  .qibla-arrow .arrow-line { width: 2px; height: 20px; background: linear-gradient(to bottom, var(--gold), transparent); }
  .top-pointer { position: absolute; top: -2px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 7px solid transparent; border-right: 7px solid transparent; border-top: 12px solid var(--gold); filter: drop-shadow(0 2px 6px rgba(201,168,76,0.5)); z-index: 10; }
  .center-dot { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 8px; height: 8px; background: var(--gold); border-radius: 50%; box-shadow: 0 0 12px rgba(201,168,76,0.6); z-index: 5; }

  .degree-readout { text-align: center; margin: 8px 0 2px; }
  .degree-value { font-size: 44px; font-weight: 300; color: var(--gold-light); letter-spacing: -2px; line-height: 1; }
  .degree-value .deg-symbol { font-size: 24px; vertical-align: super; margin-left: 2px; opacity: 0.6; }
  .degree-label { font-size: 12px; color: var(--text-muted); margin-top: 2px; letter-spacing: 2px; text-transform: uppercase; }

  .alignment-msg {
    margin-top: 6px; padding: 8px 20px; border-radius: 100px;
    font-family: 'Amiri', serif; font-size: 16px; color: var(--emerald);
    background: rgba(45,212,168,0.08); border: 1px solid rgba(45,212,168,0.2);
    opacity: 0; transform: scale(0.95); transition: all 0.4s ease;
    pointer-events: none; min-height: 38px;
  }
  .alignment-msg.visible { opacity: 1; transform: scale(1); }

  /* ‚îÄ‚îÄ Map ‚îÄ‚îÄ */
  .map-section { width: 100%; margin-top: 10px; }
  .map-section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .map-section-header h2 { font-family: 'Amiri', serif; font-size: 18px; color: var(--gold); font-weight: 400; }
  .map-section-header .map-hint { font-size: 11px; color: var(--text-muted); }
  .map-container { width: 100%; height: 260px; border-radius: 16px; overflow: hidden; border: 1px solid rgba(201,168,76,0.15); position: relative; background: #0d1117; }
  #map { width: 100%; height: 100%; }
  .leaflet-tile-pane { filter: brightness(0.65) contrast(1.15) saturate(0.25) hue-rotate(180deg) invert(1); }
  .leaflet-control-attribution { display: none !important; }
  .leaflet-control-zoom { display: none !important; }
  .user-marker { width: 14px; height: 14px; background: var(--emerald); border: 2.5px solid #fff; border-radius: 50%; box-shadow: 0 0 10px rgba(45,212,168,0.6); }
  .kaaba-marker { font-size: 22px; line-height: 1; filter: drop-shadow(0 0 6px rgba(201,168,76,0.7)); }

  .map-legend { display: flex; gap: 16px; margin-top: 8px; justify-content: center; font-size: 11px; color: var(--text-muted); }
  .map-legend .legend-item { display: flex; align-items: center; gap: 5px; }
  .legend-swatch { width: 18px; height: 3px; border-radius: 2px; }
  .legend-swatch.gold { background: repeating-linear-gradient(90deg, var(--gold) 0 5px, transparent 5px 8px); height: 2.5px; }
  .legend-swatch.green { background: var(--emerald); }

  /* ‚îÄ‚îÄ Offline map controls ‚îÄ‚îÄ */
  .offline-map-section {
    width: 100%; margin-top: 12px;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(201,168,76,0.1);
    border-radius: 14px;
    padding: 14px 16px;
  }

  .offline-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }
  .offline-header h3 {
    font-family: 'Amiri', serif; font-size: 16px; color: var(--gold); font-weight: 400;
  }
  .offline-cache-status {
    font-size: 11px; color: var(--text-muted);
    display: flex; align-items: center; gap: 5px;
  }
  .offline-cache-status .cached-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--text-muted);
  }
  .offline-cache-status .cached-dot.has-cache { background: var(--emerald); }

  .offline-desc {
    font-size: 12px; color: var(--text-muted); line-height: 1.5;
    margin-bottom: 12px;
  }

  .offline-controls { display: flex; gap: 8px; flex-wrap: wrap; }

  .btn-offline {
    padding: 9px 16px; border: none; border-radius: 100px;
    font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600;
    cursor: pointer; transition: transform 0.15s, opacity 0.15s;
    display: flex; align-items: center; gap: 6px;
  }
  .btn-offline:active { transform: scale(0.97); }
  .btn-offline:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-offline.primary {
    background: linear-gradient(135deg, var(--gold-dark), var(--gold));
    color: var(--bg-deep);
  }
  .btn-offline.secondary {
    background: rgba(255,255,255,0.06);
    color: var(--text-muted);
    border: 1px solid rgba(255,255,255,0.08);
  }

  .btn-offline .btn-icon { font-size: 14px; }

  /* Progress bar */
  .offline-progress {
    margin-top: 12px;
    display: none;
  }
  .offline-progress.active { display: block; }

  .progress-bar-track {
    width: 100%; height: 6px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px; overflow: hidden;
    margin-bottom: 6px;
  }
  .progress-bar-fill {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--gold-dark), var(--gold));
    border-radius: 3px;
    transition: width 0.3s ease;
  }
  .progress-bar-fill.complete {
    background: linear-gradient(90deg, var(--emerald-dark), var(--emerald));
  }

  .progress-text {
    font-size: 11px; color: var(--text-muted);
    display: flex; justify-content: space-between;
  }

  /* ‚îÄ‚îÄ Info panel ‚îÄ‚îÄ */
  .info-panel { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
  .info-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(201,168,76,0.1); border-radius: 12px; padding: 12px 14px; }
  .info-card .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 4px; }
  .info-card .value { font-size: 15px; font-weight: 500; color: var(--text-primary); }
  .info-card .value small { font-size: 11px; font-weight: 400; color: var(--text-muted); }

  /* ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ */
  .overlay {
    position: fixed; inset: 0; z-index: 100; background: rgba(10,14,23,0.97);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 40px; text-align: center; transition: opacity 0.5s;
  }
  .overlay.hidden { opacity: 0; pointer-events: none; }
  .overlay .icon { font-size: 48px; margin-bottom: 20px; }
  .overlay h2 { font-family: 'Amiri', serif; font-size: 24px; color: var(--gold); margin-bottom: 12px; }
  .overlay p { font-size: 14px; color: var(--text-muted); line-height: 1.6; max-width: 300px; margin-bottom: 20px; }

  .btn {
    padding: 14px 32px; border: none; border-radius: 100px;
    background: linear-gradient(135deg, var(--gold-dark), var(--gold));
    color: var(--bg-deep); font-family: 'DM Sans', sans-serif;
    font-size: 15px; font-weight: 600; cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn:hover { transform: scale(1.03); box-shadow: 0 4px 20px rgba(201,168,76,0.3); }
  .btn:active { transform: scale(0.98); }

  /* ‚îÄ‚îÄ Install banner ‚îÄ‚îÄ */
  .install-banner {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: linear-gradient(to top, rgba(10,14,23,0.98), rgba(10,14,23,0.92));
    border-top: 1px solid rgba(201,168,76,0.2); padding: 16px 20px;
    padding-bottom: max(16px, env(safe-area-inset-bottom));
    display: flex; align-items: center; justify-content: space-between;
    z-index: 90; transform: translateY(100%); transition: transform 0.4s ease;
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  }
  .install-banner.visible { transform: translateY(0); }
  .install-banner .install-text { flex: 1; }
  .install-banner .install-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 2px; }
  .install-banner .install-sub { font-size: 12px; color: var(--text-muted); }
  .install-banner .btn-install { padding: 10px 20px; border: none; border-radius: 100px; background: var(--gold); color: var(--bg-deep); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; margin-left: 12px; }
  .install-banner .btn-dismiss { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; padding: 8px; margin-left: 4px; line-height: 1; }

  .calibration-hint {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(201,168,76,0.1); border: 1px solid rgba(201,168,76,0.2);
    border-radius: 12px; padding: 10px 18px; font-size: 12px; color: var(--text-muted);
    z-index: 50; text-align: center; opacity: 0; transition: opacity 0.5s;
    pointer-events: none; max-width: 320px;
  }
  .calibration-hint.visible { opacity: 1; }

  @keyframes pulse { 0%,100%{opacity:.6} 50%{opacity:1} }
  .loading-pulse { animation: pulse 1.5s infinite; }
</style>
</head>
<body>

<div class="overlay" id="overlay">
  <div class="icon">üïã</div>
  <h2>Qibla Compass</h2>
  <p>This app needs access to your location and device compass to calculate the direction of the Kaaba in Makkah.</p>
  <button class="btn" id="startBtn">Enable Compass</button>
  <p id="overlayError" style="color:#E5484D;margin-top:16px;display:none"></p>
</div>

<div class="install-banner" id="installBanner">
  <div class="install-text">
    <div class="install-title">Install Qibla Compass</div>
    <div class="install-sub">Add to home screen for quick access</div>
  </div>
  <button class="btn-install" id="installBtn">Install</button>
  <button class="btn-dismiss" id="dismissInstall">‚úï</button>
</div>

<div class="app">
  <div class="header">
    <h1>Qibla Compass</h1>
    <div class="arabic-title">ÿ®ŸàÿµŸÑÿ© ÿßŸÑŸÇÿ®ŸÑÿ©</div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="gpsDot"></div>
    <span id="statusText" class="loading-pulse">Waiting for sensors‚Ä¶</span>
  </div>

  <div class="compass-wrapper">
    <div class="compass-ring" id="compassRing"></div>
    <div class="top-pointer"></div>
    <div class="compass-inner">
      <div class="compass-plate" id="compassPlate">
        <svg viewBox="0 0 260 260">
          <g id="ticks"></g>
          <text x="130" y="32" text-anchor="middle" fill="#E5484D" font-family="DM Sans" font-size="15" font-weight="600">N</text>
          <text x="236" y="135" text-anchor="middle" fill="rgba(240,237,230,0.5)" font-family="DM Sans" font-size="13" font-weight="500">E</text>
          <text x="130" y="238" text-anchor="middle" fill="rgba(240,237,230,0.5)" font-family="DM Sans" font-size="13" font-weight="500">S</text>
          <text x="24" y="135" text-anchor="middle" fill="rgba(240,237,230,0.5)" font-family="DM Sans" font-size="13" font-weight="500">W</text>
        </svg>
      </div>
      <div class="qibla-indicator" id="qiblaIndicator">
        <div class="qibla-arrow">
          <div class="kaaba-icon">üïã</div>
          <div class="arrow-line"></div>
        </div>
      </div>
      <div class="center-dot"></div>
    </div>
  </div>

  <div class="degree-readout">
    <div class="degree-value" id="degreeValue">--<span class="deg-symbol">¬∞</span></div>
    <div class="degree-label">Qibla Bearing</div>
  </div>

  <div class="alignment-msg" id="alignmentMsg">Facing the Kaaba ‚ú¶</div>

  <div class="map-section">
    <div class="map-section-header">
      <h2>Your Path to Makkah</h2>
      <span class="map-hint">Verify with landmarks</span>
    </div>
    <div class="map-container">
      <div id="map"></div>
    </div>
    <div class="map-legend">
      <div class="legend-item"><span class="legend-swatch gold"></span> Qibla direction</div>
      <div class="legend-item"><span class="legend-swatch green"></span> You're facing</div>
    </div>
  </div>

  <!-- Offline Map Controls -->
  <div class="offline-map-section" id="offlineSection">
    <div class="offline-header">
      <h3>Offline Map</h3>
      <div class="offline-cache-status">
        <span class="cached-dot" id="cacheDot"></span>
        <span id="cacheStatusText">Checking‚Ä¶</span>
      </div>
    </div>
    <div class="offline-desc">
      Save map tiles around your location so the map works without internet. Downloads tiles at multiple zoom levels (~5‚Äì15 MB).
    </div>
    <div class="offline-controls">
      <button class="btn-offline primary" id="btnCacheTiles" disabled>
        <span class="btn-icon">‚Üì</span> Save Map for Offline
      </button>
      <button class="btn-offline secondary" id="btnClearCache" style="display:none">
        <span class="btn-icon">‚úï</span> Clear Cache
      </button>
    </div>
    <div class="offline-progress" id="offlineProgress">
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressFill"></div>
      </div>
      <div class="progress-text">
        <span id="progressLabel">Downloading tiles‚Ä¶</span>
        <span id="progressPct">0%</span>
      </div>
    </div>
  </div>

  <div class="info-panel">
    <div class="info-card">
      <div class="label">Distance</div>
      <div class="value" id="distanceValue">-- <small>km</small></div>
    </div>
    <div class="info-card">
      <div class="label">Bearing</div>
      <div class="value" id="bearingValue">--¬∞</div>
    </div>
    <div class="info-card">
      <div class="label">Latitude</div>
      <div class="value" id="latValue">--</div>
    </div>
    <div class="info-card">
      <div class="label">Longitude</div>
      <div class="value" id="lngValue">--</div>
    </div>
  </div>
</div>

<div class="calibration-hint" id="calibrationHint">
  Tip: Move your phone in a figure-8 to calibrate. Match the green line on the map to real landmarks.
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
  // ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ
  let swReady = null;
  if ('serviceWorker' in navigator) {
    swReady = navigator.serviceWorker.register('sw.js').then(reg => {
      // Wait for the SW to be active
      return navigator.serviceWorker.ready;
    }).catch(() => null);
  }

  // ‚îÄ‚îÄ Install Prompt ‚îÄ‚îÄ
  let deferredPrompt = null;
  const installBanner = document.getElementById('installBanner');

  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    setTimeout(() => installBanner.classList.add('visible'), 2000);
  });

  document.getElementById('installBtn').addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBanner.classList.remove('visible');
  });

  document.getElementById('dismissInstall').addEventListener('click', () => installBanner.classList.remove('visible'));
  window.addEventListener('appinstalled', () => { installBanner.classList.remove('visible'); deferredPrompt = null; });

  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  if (!isStandalone && /iPhone|iPad/.test(navigator.userAgent) && !deferredPrompt) {
    setTimeout(() => {
      installBanner.querySelector('.install-title').textContent = 'Add to Home Screen';
      installBanner.querySelector('.install-sub').textContent = 'Tap Share ‚éã then "Add to Home Screen"';
      installBanner.querySelector('.btn-install').style.display = 'none';
      installBanner.classList.add('visible');
    }, 3000);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Qibla Compass
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const KAABA_LAT = 21.4225, KAABA_LNG = 39.8262;
  let userLat = null, userLng = null, qiblaBearing = null, currentHeading = 0;
  let compassSupported = false;
  let map = null, userMarker = null, qiblaLine = null, headingLine = null;
  let mapInitialized = false;

  const $ = id => document.getElementById(id);

  // Compass ticks
  (function() {
    const ticks = $('ticks');
    for (let i = 0; i < 360; i += 5) {
      const isMajor = i % 30 === 0, isMinor = i % 15 === 0;
      const len = isMajor ? 12 : (isMinor ? 8 : 4);
      const r = 125, rad = (i - 90) * Math.PI / 180;
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', 130 + (r-len)*Math.cos(rad));
      line.setAttribute('y1', 130 + (r-len)*Math.sin(rad));
      line.setAttribute('x2', 130 + r*Math.cos(rad));
      line.setAttribute('y2', 130 + r*Math.sin(rad));
      line.setAttribute('stroke', isMajor ? 'rgba(201,168,76,0.6)' : 'rgba(240,237,230,0.15)');
      line.setAttribute('stroke-width', isMajor ? 1.5 : 0.8);
      ticks.appendChild(line);
    }
  })();

  function toRad(d) { return d * Math.PI / 180; }
  function toDeg(r) { return r * 180 / Math.PI; }

  function calculateQibla(lat, lng) {
    const œÜ1 = toRad(lat), œÜ2 = toRad(KAABA_LAT), ŒîŒª = toRad(KAABA_LNG - lng);
    return (toDeg(Math.atan2(Math.sin(ŒîŒª), Math.cos(œÜ1)*Math.tan(œÜ2) - Math.sin(œÜ1)*Math.cos(ŒîŒª))) + 360) % 360;
  }

  function calculateDistance(lat, lng) {
    const R = 6371, ŒîœÜ = toRad(KAABA_LAT - lat), ŒîŒª = toRad(KAABA_LNG - lng);
    const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(toRad(lat))*Math.cos(toRad(KAABA_LAT))*Math.sin(ŒîŒª/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function greatCirclePath(lat1, lng1, lat2, lng2, steps = 100) {
    const œÜ1=toRad(lat1), Œª1=toRad(lng1), œÜ2=toRad(lat2), Œª2=toRad(lng2);
    const d = 2*Math.asin(Math.sqrt(Math.sin((œÜ2-œÜ1)/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin((Œª2-Œª1)/2)**2));
    if (d < 1e-10) return [[lat1,lng1],[lat2,lng2]];
    const pts = [];
    for (let i = 0; i <= steps; i++) {
      const t = i/steps;
      const A = Math.sin((1-t)*d)/Math.sin(d), B = Math.sin(t*d)/Math.sin(d);
      const x = A*Math.cos(œÜ1)*Math.cos(Œª1) + B*Math.cos(œÜ2)*Math.cos(Œª2);
      const y = A*Math.cos(œÜ1)*Math.sin(Œª1) + B*Math.cos(œÜ2)*Math.sin(Œª2);
      const z = A*Math.sin(œÜ1) + B*Math.sin(œÜ2);
      pts.push([toDeg(Math.atan2(z, Math.sqrt(x*x+y*y))), toDeg(Math.atan2(y, x))]);
    }
    return pts;
  }

  function destPoint(lat, lng, bearing, km) {
    const R=6371, œÜ1=toRad(lat), Œª1=toRad(lng), brng=toRad(bearing), d=km/R;
    const œÜ2 = Math.asin(Math.sin(œÜ1)*Math.cos(d)+Math.cos(œÜ1)*Math.sin(d)*Math.cos(brng));
    const Œª2 = Œª1+Math.atan2(Math.sin(brng)*Math.sin(d)*Math.cos(œÜ1), Math.cos(d)-Math.sin(œÜ1)*Math.sin(œÜ2));
    return [toDeg(œÜ2), toDeg(Œª2)];
  }

  // Map
  function initMap(lat, lng) {
    if (mapInitialized) return;
    mapInitialized = true;
    map = L.map('map', { zoomControl:false, attributionControl:false }).setView([lat,lng], 5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 18, subdomains: 'abcd'
    }).addTo(map);

    L.marker([KAABA_LAT, KAABA_LNG], {
      icon: L.divIcon({ html:'<div class="kaaba-marker">üïã</div>', className:'', iconSize:[24,24], iconAnchor:[12,12] })
    }).addTo(map).bindTooltip('Makkah ¬∑ ÿßŸÑŸÉÿπÿ®ÿ©', { direction:'top', offset:[0,-14] });

    userMarker = L.marker([lat,lng], {
      icon: L.divIcon({ html:'<div class="user-marker"></div>', className:'', iconSize:[14,14], iconAnchor:[7,7] })
    }).addTo(map).bindTooltip('You', { direction:'top', offset:[0,-10] });

    qiblaLine = L.polyline(greatCirclePath(lat, lng, KAABA_LAT, KAABA_LNG), {
      color:'#C9A84C', weight:2.5, opacity:0.85, dashArray:'8 6', lineCap:'round'
    }).addTo(map);

    const headingDist = Math.min(calculateDistance(lat, lng) * 0.15, 300);
    headingLine = L.polyline([[lat,lng], destPoint(lat, lng, currentHeading, headingDist)], {
      color:'#2DD4A8', weight:3, opacity:0.7, lineCap:'round'
    }).addTo(map);

    map.fitBounds(L.latLngBounds([[lat,lng],[KAABA_LAT,KAABA_LNG]]), { padding:[35,35] });
  }

  function updateMap(lat, lng) {
    if (!mapInitialized) { initMap(lat, lng); return; }
    userMarker.setLatLng([lat, lng]);
    qiblaLine.setLatLngs(greatCirclePath(lat, lng, KAABA_LAT, KAABA_LNG));
    updateHeadingLine(lat, lng);
  }

  function updateHeadingLine(lat, lng) {
    if (!headingLine) return;
    const d = Math.min(calculateDistance(lat, lng) * 0.15, 300);
    headingLine.setLatLngs([[lat, lng], destPoint(lat, lng, currentHeading, Math.max(d, 30))]);
  }

  function updateUI() {
    $('compassPlate').style.transform = `rotate(${-currentHeading}deg)`;
    if (qiblaBearing !== null) {
      $('qiblaIndicator').style.transform = `rotate(${qiblaBearing - currentHeading}deg)`;
      $('degreeValue').innerHTML = `${Math.round(qiblaBearing)}<span class="deg-symbol">¬∞</span>`;
      let diff = ((qiblaBearing - currentHeading) % 360 + 360) % 360;
      if (diff > 180) diff = 360 - diff;
      $('alignmentMsg').classList.toggle('visible', diff < 5);
      $('compassRing').classList.toggle('aligned', diff < 5);
    }
    if (userLat !== null && mapInitialized) updateHeadingLine(userLat, userLng);
  }

  let headingBuf = [];
  function smoothHeading(raw) {
    headingBuf.push(raw);
    if (headingBuf.length > 5) headingBuf.shift();
    let s=0, c=0;
    for (const h of headingBuf) { s += Math.sin(toRad(h)); c += Math.cos(toRad(h)); }
    return (toDeg(Math.atan2(s, c)) + 360) % 360;
  }

  function handleOrientation(e) {
    let heading = e.webkitCompassHeading !== undefined ? e.webkitCompassHeading
                : e.alpha !== null ? (360 - e.alpha) % 360 : null;
    if (heading === null) return;
    if (!compassSupported) {
      compassSupported = true;
      $('statusText').textContent = userLat !== null ? 'Compass active' : 'Waiting for GPS‚Ä¶';
      $('statusText').classList.remove('loading-pulse');
      $('calibrationHint').classList.add('visible');
      setTimeout(() => $('calibrationHint').classList.remove('visible'), 7000);
    }
    currentHeading = smoothHeading(heading);
    updateUI();
  }

  function onLocationSuccess(pos) {
    gpsReceived = true;
    // Remove help banner if it was shown
    const helpEl = $('gpsHelp');
    if (helpEl) helpEl.remove();

    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
    qiblaBearing = calculateQibla(userLat, userLng);
    const dist = calculateDistance(userLat, userLng);

    $('gpsDot').classList.add('active');
    $('statusText').textContent = compassSupported ? 'Compass active' : 'Waiting for compass‚Ä¶';
    $('statusText').classList.remove('loading-pulse');
    $('distanceValue').innerHTML = `${dist.toFixed(0)} <small>km</small>`;
    $('bearingValue').textContent = `${qiblaBearing.toFixed(1)}¬∞`;
    $('latValue').textContent = userLat.toFixed(4);
    $('lngValue').textContent = userLng.toFixed(4);

    // Enable offline map button once we have location
    $('btnCacheTiles').disabled = false;

    updateMap(userLat, userLng);
    updateUI();
  }

  function onLocationError(err) {
    $('gpsDot').classList.add('error');
    $('statusText').classList.remove('loading-pulse');

    let msg = 'Location unavailable';
    let help = '';

    if (err && err.code) {
      switch (err.code) {
        case 1: // PERMISSION_DENIED
          msg = 'Location permission denied';
          help = 'Go to Settings ‚Üí Privacy ‚Üí Location Services ‚Üí Safari Websites and set to "While Using." Then reload this page.';
          break;
        case 2: // POSITION_UNAVAILABLE
          msg = 'GPS signal not found';
          help = 'Try moving near a window or stepping outside. Indoor GPS can be unreliable.';
          break;
        case 3: // TIMEOUT
          msg = 'GPS timed out';
          help = 'Your device is taking too long to get a fix. Try moving to an area with better reception and reload.';
          break;
      }
    }

    $('statusText').textContent = msg;

    // Show help text below status bar
    if (help) showGpsHelp(msg, help);
  }

  function showGpsHelp(title, message) {
    let helpEl = $('gpsHelp');
    if (!helpEl) {
      helpEl = document.createElement('div');
      helpEl.id = 'gpsHelp';
      helpEl.style.cssText = 'width:100%;max-width:380px;margin:8px 16px;padding:12px 16px;background:rgba(229,72,77,0.08);border:1px solid rgba(229,72,77,0.2);border-radius:12px;font-size:13px;color:var(--text-muted);line-height:1.5;text-align:center;';
      // Insert after status bar
      const statusBar = $('statusText').closest('.status-bar');
      statusBar.parentNode.insertBefore(helpEl, statusBar.nextSibling);
    }
    helpEl.innerHTML = `<strong style="color:#E5484D;display:block;margin-bottom:4px">${title}</strong>${message}`;
  }

  // Safety timeout ‚Äî if GPS hasn't responded at all after 20s, show help
  let gpsReceived = false;
  function startGpsTimeout() {
    setTimeout(() => {
      if (!gpsReceived && !$('gpsHelp')) {
        $('gpsDot').classList.add('error');
        $('statusText').textContent = 'GPS not responding';
        $('statusText').classList.remove('loading-pulse');
        showGpsHelp('GPS not responding', 'Make sure Location Services are enabled: Settings ‚Üí Privacy & Security ‚Üí Location Services ‚Üí On. Also check that Safari (or your browser) has location permission. Then reload this page.');
      }
    }, 20000);
  }

  async function startApp() {
    if ('geolocation' in navigator) {
      navigator.geolocation.watchPosition(onLocationSuccess, onLocationError, {
        enableHighAccuracy: true, maximumAge: 10000, timeout: 15000
      });
      startGpsTimeout();
    } else { onLocationError({ code: 2 }); }

    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const perm = await DeviceOrientationEvent.requestPermission();
        if (perm === 'granted') window.addEventListener('deviceorientation', handleOrientation, true);
        else { $('overlayError').textContent = 'Compass permission denied. Go to Settings ‚Üí Safari ‚Üí Motion & Orientation Access to re-enable.'; $('overlayError').style.display = 'block'; return; }
      } catch(e) { $('overlayError').textContent = e.message; $('overlayError').style.display = 'block'; return; }
    } else if ('DeviceOrientationEvent' in window) {
      window.addEventListener('deviceorientation', handleOrientation, true);
      setTimeout(() => {
        if (!compassSupported && qiblaBearing !== null) {
          $('statusText').textContent = 'No compass ‚Äî showing bearing only';
          $('statusText').classList.remove('loading-pulse');
          updateUI();
        }
      }, 3000);
    } else {
      $('statusText').textContent = 'No compass sensor';
      $('statusText').classList.remove('loading-pulse');
    }

    $('overlay').classList.add('hidden');
    // Check cache status once SW is ready
    checkCacheStatus();
  }

  $('startBtn').addEventListener('click', startApp);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Offline Map Tile Pre-caching
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Convert lat/lng to tile coordinates at a given zoom
  function latLngToTile(lat, lng, zoom) {
    const n = Math.pow(2, zoom);
    const x = Math.floor((lng + 180) / 360 * n);
    const latRad = lat * Math.PI / 180;
    const y = Math.floor((1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n);
    return { x, y, z: zoom };
  }

  // Generate tile URLs for a bounding box at specific zoom levels
  function generateTileUrls(lat, lng, zoomLevels, radiusKm) {
    const urls = new Set();
    const subdomains = ['a', 'b', 'c', 'd'];

    for (const z of zoomLevels) {
      // Calculate tile range based on radius
      // At zoom z, each tile covers roughly (40075km / 2^z) in width at equator
      const tileWidthKm = 40075 * Math.cos(toRad(lat)) / Math.pow(2, z);
      const tilesNeeded = Math.ceil(radiusKm / tileWidthKm) + 1;

      const center = latLngToTile(lat, lng, z);
      const n = Math.pow(2, z);

      for (let dx = -tilesNeeded; dx <= tilesNeeded; dx++) {
        for (let dy = -tilesNeeded; dy <= tilesNeeded; dy++) {
          const tx = ((center.x + dx) % n + n) % n;
          const ty = center.y + dy;
          if (ty < 0 || ty >= n) continue;

          const sub = subdomains[(tx + ty) % subdomains.length];
          urls.add(`https://${sub}.basemaps.cartocdn.com/light_all/${z}/${tx}/${ty}.png`);
        }
      }
    }

    // Also cache tiles along the great circle path to Makkah at lower zooms
    const pathZooms = zoomLevels.filter(z => z <= 8);
    const pathPts = greatCirclePath(lat, lng, KAABA_LAT, KAABA_LNG, 50);
    for (const z of pathZooms) {
      for (const [pLat, pLng] of pathPts) {
        const tile = latLngToTile(pLat, pLng, z);
        const n = Math.pow(2, z);
        const sub = subdomains[(tile.x + tile.y) % subdomains.length];
        urls.add(`https://${sub}.basemaps.cartocdn.com/light_all/${z}/${tile.x}/${tile.y}.png`);
        // Also grab neighbors for the path
        for (const d of [-1, 0, 1]) {
          for (const e of [-1, 0, 1]) {
            const nx = ((tile.x + d) % n + n) % n;
            const ny = tile.y + e;
            if (ny >= 0 && ny < n) {
              const ns = subdomains[(nx + ny) % subdomains.length];
              urls.add(`https://${ns}.basemaps.cartocdn.com/light_all/${z}/${nx}/${ny}.png`);
            }
          }
        }
      }
    }

    return [...urls];
  }

  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // Listen for SW messages
  navigator.serviceWorker?.addEventListener('message', e => {
    const { data } = e;
    if (!data) return;

    if (data.type === 'PRECACHE_PROGRESS') {
      const pct = Math.round(data.done / data.total * 100);
      $('progressFill').style.width = pct + '%';
      $('progressPct').textContent = pct + '%';
      $('progressLabel').textContent = `Downloading tiles‚Ä¶ ${data.done}/${data.total}`;
    }

    if (data.type === 'PRECACHE_COMPLETE') {
      $('progressFill').style.width = '100%';
      $('progressFill').classList.add('complete');
      const msg = data.errors > 0
        ? `Done! Cached ${data.total - data.errors} tiles (${data.errors} failed)`
        : `Done! Cached ${data.total} tiles`;
      $('progressLabel').textContent = msg;
      $('progressPct').textContent = '‚úì';
      $('btnCacheTiles').disabled = false;
      $('btnCacheTiles').innerHTML = '<span class="btn-icon">‚Üì</span> Update Offline Map';
      checkCacheStatus();
    }

    if (data.type === 'TILE_CACHE_CLEARED') {
      $('btnClearCache').style.display = 'none';
      $('cacheDot').classList.remove('has-cache');
      $('cacheStatusText').textContent = 'No cached tiles';
      $('offlineProgress').classList.remove('active');
      $('progressFill').style.width = '0%';
      $('progressFill').classList.remove('complete');
      $('btnCacheTiles').innerHTML = '<span class="btn-icon">‚Üì</span> Save Map for Offline';
    }

    if (data.type === 'TILE_CACHE_SIZE') {
      if (data.count > 0) {
        $('cacheDot').classList.add('has-cache');
        $('cacheStatusText').textContent = `${data.count} tiles ¬∑ ${formatBytes(data.bytes)}`;
        $('btnClearCache').style.display = '';
        $('btnCacheTiles').innerHTML = '<span class="btn-icon">‚Üì</span> Update Offline Map';
      } else {
        $('cacheDot').classList.remove('has-cache');
        $('cacheStatusText').textContent = 'No cached tiles';
        $('btnClearCache').style.display = 'none';
      }
    }
  });

  async function checkCacheStatus() {
    const reg = await swReady;
    if (reg?.active) {
      navigator.serviceWorker.controller?.postMessage({ type: 'GET_TILE_CACHE_SIZE' });
    }
  }

  // Cache tiles button
  $('btnCacheTiles').addEventListener('click', async () => {
    if (!userLat || !userLng) return;

    const btn = $('btnCacheTiles');
    btn.disabled = true;

    // Generate tile URLs:
    // - Zoom 3-6: entire great circle path (overview)
    // - Zoom 7-10: wider area around user (~50km)
    // - Zoom 11-14: close area around user (~10km, street level for landmarks)
    const urls = generateTileUrls(userLat, userLng, [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14], 12);

    // Show progress
    $('offlineProgress').classList.add('active');
    $('progressFill').style.width = '0%';
    $('progressFill').classList.remove('complete');
    $('progressLabel').textContent = `Downloading ${urls.length} tiles‚Ä¶`;
    $('progressPct').textContent = '0%';

    // Send to service worker
    const reg = await swReady;
    if (reg?.active) {
      navigator.serviceWorker.controller.postMessage({
        type: 'PRECACHE_TILES',
        tiles: urls
      });
    }
  });

  // Clear cache button
  $('btnClearCache').addEventListener('click', async () => {
    const reg = await swReady;
    if (reg?.active) {
      navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_TILE_CACHE' });
    }
  });

  // Check cache status on load
  if (swReady) {
    swReady.then(() => {
      // Small delay to ensure controller is set
      setTimeout(checkCacheStatus, 500);
    });
  }
</script>
</body>
</html>
