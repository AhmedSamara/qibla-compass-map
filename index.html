<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Qibla Compass</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<style>
  :root {
    --gold: #C9A84C;
    --gold-light: #E8D48B;
    --gold-dark: #8B6914;
    --bg-deep: #0A0E17;
    --bg-card: #111827;
    --text-primary: #F0EDE6;
    --text-muted: #8896AB;
    --emerald: #2DD4A8;
    --emerald-dark: #0D9373;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-deep);
    color: var(--text-primary);
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    overflow-y: auto;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(1px 1px at 10% 20%, rgba(201,168,76,0.4), transparent),
      radial-gradient(1px 1px at 30% 65%, rgba(201,168,76,0.3), transparent),
      radial-gradient(1px 1px at 50% 10%, rgba(255,255,255,0.3), transparent),
      radial-gradient(1px 1px at 70% 40%, rgba(201,168,76,0.2), transparent),
      radial-gradient(1px 1px at 90% 80%, rgba(255,255,255,0.2), transparent),
      radial-gradient(1.5px 1.5px at 15% 85%, rgba(201,168,76,0.5), transparent),
      radial-gradient(1px 1px at 45% 45%, rgba(255,255,255,0.2), transparent),
      radial-gradient(1px 1px at 80% 15%, rgba(201,168,76,0.3), transparent),
      radial-gradient(1.5px 1.5px at 60% 90%, rgba(255,255,255,0.3), transparent),
      radial-gradient(1px 1px at 25% 35%, rgba(201,168,76,0.2), transparent);
    z-index: 0;
    pointer-events: none;
  }

  body::after {
    content: '';
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(201,168,76,0.06) 0%, transparent 70%);
    z-index: 0;
    pointer-events: none;
  }

  .app {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 420px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 16px 32px;
    gap: 4px;
  }

  .header { text-align: center; }

  .header h1 {
    font-family: 'Amiri', serif;
    font-size: 26px;
    font-weight: 700;
    color: var(--gold);
    letter-spacing: 1px;
  }

  .header .arabic-title {
    font-family: 'Amiri', serif;
    font-size: 18px;
    color: var(--gold-light);
    opacity: 0.7;
    margin-top: -2px;
  }

  .status-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 8px 0;
    padding: 6px 14px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(201,168,76,0.15);
    border-radius: 100px;
    font-size: 12px;
    color: var(--text-muted);
  }

  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text-muted);
    transition: background 0.4s;
    flex-shrink: 0;
  }

  .status-dot.active { background: var(--emerald); box-shadow: 0 0 8px rgba(45,212,168,0.5); }
  .status-dot.error { background: #E5484D; }

  /* â”€â”€ Compass â”€â”€ */
  .compass-wrapper {
    position: relative;
    width: 280px; height: 280px;
    flex-shrink: 0;
  }

  .compass-ring {
    position: absolute; inset: 0;
    border-radius: 50%;
    border: 1.5px solid rgba(201,168,76,0.25);
    transition: border-color 0.5s, box-shadow 0.5s;
  }
  .compass-ring.aligned { border-color: var(--emerald); box-shadow: 0 0 30px rgba(45,212,168,0.15); }

  .compass-inner {
    position: absolute; inset: 10px;
    border-radius: 50%;
    background: radial-gradient(circle at 40% 35%, rgba(25,35,55,0.9), rgba(10,14,23,0.95));
    border: 1px solid rgba(201,168,76,0.12);
    overflow: hidden;
  }
  .compass-inner::before {
    content: ''; position: absolute; inset: 0;
    background: repeating-conic-gradient(from 0deg, transparent 0deg 10deg, rgba(201,168,76,0.02) 10deg 20deg);
    border-radius: 50%;
  }

  .compass-plate {
    position: absolute; inset: 18px;
    transition: transform 0.12s ease-out;
  }
  .compass-plate svg { width: 100%; height: 100%; }

  .qibla-indicator {
    position: absolute; inset: 4px;
    transition: transform 0.12s ease-out;
    pointer-events: none;
  }

  .qibla-arrow {
    position: absolute; top: 6px; left: 50%;
    transform: translateX(-50%);
    display: flex; flex-direction: column; align-items: center;
    filter: drop-shadow(0 0 12px rgba(201,168,76,0.6));
  }
  .qibla-arrow .kaaba-icon { font-size: 20px; line-height: 1; }
  .qibla-arrow .arrow-line { width: 2px; height: 20px; background: linear-gradient(to bottom, var(--gold), transparent); }

  .top-pointer {
    position: absolute; top: -2px; left: 50%; transform: translateX(-50%);
    width: 0; height: 0;
    border-left: 7px solid transparent; border-right: 7px solid transparent;
    border-top: 12px solid var(--gold);
    filter: drop-shadow(0 2px 6px rgba(201,168,76,0.5));
    z-index: 10;
  }

  .center-dot {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    width: 8px; height: 8px;
    background: var(--gold); border-radius: 50%;
    box-shadow: 0 0 12px rgba(201,168,76,0.6); z-index: 5;
  }

  /* â”€â”€ Degree readout â”€â”€ */
  .degree-readout { text-align: center; margin: 8px 0 2px; }
  .degree-value { font-size: 44px; font-weight: 300; color: var(--gold-light); letter-spacing: -2px; line-height: 1; }
  .degree-value .deg-symbol { font-size: 24px; vertical-align: super; margin-left: 2px; opacity: 0.6; }
  .degree-label { font-size: 12px; color: var(--text-muted); margin-top: 2px; letter-spacing: 2px; text-transform: uppercase; }

  .alignment-msg {
    margin-top: 6px; padding: 8px 20px; border-radius: 100px;
    font-family: 'Amiri', serif; font-size: 16px; color: var(--emerald);
    background: rgba(45,212,168,0.08); border: 1px solid rgba(45,212,168,0.2);
    opacity: 0; transform: scale(0.95);
    transition: all 0.4s ease; pointer-events: none; min-height: 38px;
  }
  .alignment-msg.visible { opacity: 1; transform: scale(1); }

  /* â”€â”€ Map â”€â”€ */
  .map-section { width: 100%; margin-top: 10px; }

  .map-section-header {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;
  }
  .map-section-header h2 { font-family: 'Amiri', serif; font-size: 18px; color: var(--gold); font-weight: 400; }
  .map-section-header .map-hint { font-size: 11px; color: var(--text-muted); }

  .map-container {
    width: 100%; height: 260px; border-radius: 16px; overflow: hidden;
    border: 1px solid rgba(201,168,76,0.15); position: relative; background: #0d1117;
  }
  #map { width: 100%; height: 100%; }

  /* Dark Carto tiles invert */
  .leaflet-tile-pane { filter: brightness(0.65) contrast(1.15) saturate(0.25) hue-rotate(180deg) invert(1); }
  .leaflet-control-attribution { display: none !important; }
  .leaflet-control-zoom { display: none !important; }

  .user-marker {
    width: 14px; height: 14px;
    background: var(--emerald); border: 2.5px solid #fff; border-radius: 50%;
    box-shadow: 0 0 10px rgba(45,212,168,0.6);
  }
  .kaaba-marker { font-size: 22px; line-height: 1; filter: drop-shadow(0 0 6px rgba(201,168,76,0.7)); }

  /* Map legend */
  .map-legend {
    display: flex; gap: 16px; margin-top: 8px; justify-content: center; font-size: 11px; color: var(--text-muted);
  }
  .map-legend .legend-item { display: flex; align-items: center; gap: 5px; }
  .legend-swatch {
    width: 18px; height: 3px; border-radius: 2px;
  }
  .legend-swatch.gold { background: var(--gold); }
  .legend-swatch.green { background: var(--emerald); }
  .legend-swatch.gold { background: repeating-linear-gradient(90deg, var(--gold) 0 5px, transparent 5px 8px); height: 2.5px; }

  /* â”€â”€ Info panel â”€â”€ */
  .info-panel {
    width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;
  }
  .info-card {
    background: rgba(255,255,255,0.03); border: 1px solid rgba(201,168,76,0.1);
    border-radius: 12px; padding: 12px 14px;
  }
  .info-card .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 4px; }
  .info-card .value { font-size: 15px; font-weight: 500; color: var(--text-primary); }
  .info-card .value small { font-size: 11px; font-weight: 400; color: var(--text-muted); }

  /* â”€â”€ Overlay â”€â”€ */
  .overlay {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(10,14,23,0.97);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 40px; text-align: center;
    transition: opacity 0.5s;
  }
  .overlay.hidden { opacity: 0; pointer-events: none; }
  .overlay .icon { font-size: 48px; margin-bottom: 20px; }
  .overlay h2 { font-family: 'Amiri', serif; font-size: 24px; color: var(--gold); margin-bottom: 12px; }
  .overlay p { font-size: 14px; color: var(--text-muted); line-height: 1.6; max-width: 300px; margin-bottom: 20px; }

  .btn {
    padding: 14px 32px; border: none; border-radius: 100px;
    background: linear-gradient(135deg, var(--gold-dark), var(--gold));
    color: var(--bg-deep); font-family: 'DM Sans', sans-serif;
    font-size: 15px; font-weight: 600; cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn:hover { transform: scale(1.03); box-shadow: 0 4px 20px rgba(201,168,76,0.3); }
  .btn:active { transform: scale(0.98); }

  .calibration-hint {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(201,168,76,0.1); border: 1px solid rgba(201,168,76,0.2);
    border-radius: 12px; padding: 10px 18px; font-size: 12px; color: var(--text-muted);
    z-index: 50; text-align: center; opacity: 0; transition: opacity 0.5s;
    pointer-events: none; max-width: 320px;
  }
  .calibration-hint.visible { opacity: 1; }

  @keyframes pulse { 0%,100%{opacity:.6} 50%{opacity:1} }
  .loading-pulse { animation: pulse 1.5s infinite; }
</style>
</head>
<body>

<div class="overlay" id="overlay">
  <div class="icon">ðŸ•‹</div>
  <h2>Qibla Compass</h2>
  <p>This app needs access to your location and device compass to calculate the direction of the Kaaba in Makkah.</p>
  <button class="btn" id="startBtn">Enable Compass</button>
  <p id="overlayError" style="color:#E5484D;margin-top:16px;display:none"></p>
</div>

<div class="app">
  <div class="header">
    <h1>Qibla Compass</h1>
    <div class="arabic-title">Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ù‚Ø¨Ù„Ø©</div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="gpsDot"></div>
    <span id="statusText" class="loading-pulse">Waiting for sensorsâ€¦</span>
  </div>

  <div class="compass-wrapper">
    <div class="compass-ring" id="compassRing"></div>
    <div class="top-pointer"></div>
    <div class="compass-inner">
      <div class="compass-plate" id="compassPlate">
        <svg viewBox="0 0 260 260">
          <g id="ticks"></g>
          <text x="130" y="32" text-anchor="middle" fill="#E5484D" font-family="DM Sans" font-size="15" font-weight="600">N</text>
          <text x="236" y="135" text-anchor="middle" fill="rgba(240,237,230,0.5)" font-family="DM Sans" font-size="13" font-weight="500">E</text>
          <text x="130" y="238" text-anchor="middle" fill="rgba(240,237,230,0.5)" font-family="DM Sans" font-size="13" font-weight="500">S</text>
          <text x="24" y="135" text-anchor="middle" fill="rgba(240,237,230,0.5)" font-family="DM Sans" font-size="13" font-weight="500">W</text>
        </svg>
      </div>
      <div class="qibla-indicator" id="qiblaIndicator">
        <div class="qibla-arrow">
          <div class="kaaba-icon">ðŸ•‹</div>
          <div class="arrow-line"></div>
        </div>
      </div>
      <div class="center-dot"></div>
    </div>
  </div>

  <div class="degree-readout">
    <div class="degree-value" id="degreeValue">--<span class="deg-symbol">Â°</span></div>
    <div class="degree-label">Qibla Bearing</div>
  </div>

  <div class="alignment-msg" id="alignmentMsg">Facing the Kaaba âœ¦</div>

  <!-- Map Section -->
  <div class="map-section">
    <div class="map-section-header">
      <h2>Your Path to Makkah</h2>
      <span class="map-hint">Verify with landmarks</span>
    </div>
    <div class="map-container">
      <div id="map"></div>
    </div>
    <div class="map-legend">
      <div class="legend-item"><span class="legend-swatch gold"></span> Qibla direction</div>
      <div class="legend-item"><span class="legend-swatch green"></span> You're facing</div>
    </div>
  </div>

  <div class="info-panel">
    <div class="info-card">
      <div class="label">Distance</div>
      <div class="value" id="distanceValue">-- <small>km</small></div>
    </div>
    <div class="info-card">
      <div class="label">Bearing</div>
      <div class="value" id="bearingValue">--Â°</div>
    </div>
    <div class="info-card">
      <div class="label">Latitude</div>
      <div class="value" id="latValue">--</div>
    </div>
    <div class="info-card">
      <div class="label">Longitude</div>
      <div class="value" id="lngValue">--</div>
    </div>
  </div>
</div>

<div class="calibration-hint" id="calibrationHint">
  Tip: Move your phone in a figure-8 to calibrate. Match the green line on the map to real landmarks to verify heading.
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
  const KAABA_LAT = 21.4225, KAABA_LNG = 39.8262;

  let userLat = null, userLng = null, qiblaBearing = null, currentHeading = 0;
  let compassSupported = false;
  let map = null, userMarker = null, qiblaLine = null, headingLine = null;
  let mapInitialized = false;

  const $ = id => document.getElementById(id);

  // â”€â”€ Compass ticks â”€â”€
  (function() {
    const ticks = $('ticks');
    for (let i = 0; i < 360; i += 5) {
      const isMajor = i % 30 === 0, isMinor = i % 15 === 0;
      const len = isMajor ? 12 : (isMinor ? 8 : 4);
      const r = 125, rad = (i - 90) * Math.PI / 180;
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', 130 + (r-len)*Math.cos(rad));
      line.setAttribute('y1', 130 + (r-len)*Math.sin(rad));
      line.setAttribute('x2', 130 + r*Math.cos(rad));
      line.setAttribute('y2', 130 + r*Math.sin(rad));
      line.setAttribute('stroke', isMajor ? 'rgba(201,168,76,0.6)' : 'rgba(240,237,230,0.15)');
      line.setAttribute('stroke-width', isMajor ? 1.5 : 0.8);
      ticks.appendChild(line);
    }
  })();

  // â”€â”€ Math helpers â”€â”€
  function toRad(d) { return d * Math.PI / 180; }
  function toDeg(r) { return r * 180 / Math.PI; }

  function calculateQibla(lat, lng) {
    const Ï†1 = toRad(lat), Ï†2 = toRad(KAABA_LAT), Î”Î» = toRad(KAABA_LNG - lng);
    return (toDeg(Math.atan2(Math.sin(Î”Î»), Math.cos(Ï†1)*Math.tan(Ï†2) - Math.sin(Ï†1)*Math.cos(Î”Î»))) + 360) % 360;
  }

  function calculateDistance(lat, lng) {
    const R = 6371, Î”Ï† = toRad(KAABA_LAT - lat), Î”Î» = toRad(KAABA_LNG - lng);
    const a = Math.sin(Î”Ï†/2)**2 + Math.cos(toRad(lat))*Math.cos(toRad(KAABA_LAT))*Math.sin(Î”Î»/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // Great circle interpolation
  function greatCirclePath(lat1, lng1, lat2, lng2, steps = 100) {
    const Ï†1=toRad(lat1), Î»1=toRad(lng1), Ï†2=toRad(lat2), Î»2=toRad(lng2);
    const d = 2*Math.asin(Math.sqrt(Math.sin((Ï†2-Ï†1)/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin((Î»2-Î»1)/2)**2));
    if (d < 1e-10) return [[lat1,lng1],[lat2,lng2]];
    const pts = [];
    for (let i = 0; i <= steps; i++) {
      const t = i/steps;
      const A = Math.sin((1-t)*d)/Math.sin(d), B = Math.sin(t*d)/Math.sin(d);
      const x = A*Math.cos(Ï†1)*Math.cos(Î»1) + B*Math.cos(Ï†2)*Math.cos(Î»2);
      const y = A*Math.cos(Ï†1)*Math.sin(Î»1) + B*Math.cos(Ï†2)*Math.sin(Î»2);
      const z = A*Math.sin(Ï†1) + B*Math.sin(Ï†2);
      pts.push([toDeg(Math.atan2(z, Math.sqrt(x*x+y*y))), toDeg(Math.atan2(y, x))]);
    }
    return pts;
  }

  // Destination from point along bearing
  function destPoint(lat, lng, bearing, km) {
    const R=6371, Ï†1=toRad(lat), Î»1=toRad(lng), brng=toRad(bearing), d=km/R;
    const Ï†2 = Math.asin(Math.sin(Ï†1)*Math.cos(d)+Math.cos(Ï†1)*Math.sin(d)*Math.cos(brng));
    const Î»2 = Î»1+Math.atan2(Math.sin(brng)*Math.sin(d)*Math.cos(Ï†1), Math.cos(d)-Math.sin(Ï†1)*Math.sin(Ï†2));
    return [toDeg(Ï†2), toDeg(Î»2)];
  }

  // â”€â”€ Map â”€â”€
  function initMap(lat, lng) {
    if (mapInitialized) return;
    mapInitialized = true;

    map = L.map('map', { zoomControl:false, attributionControl:false }).setView([lat,lng], 5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);

    // Kaaba marker
    L.marker([KAABA_LAT, KAABA_LNG], {
      icon: L.divIcon({ html:'<div class="kaaba-marker">ðŸ•‹</div>', className:'', iconSize:[24,24], iconAnchor:[12,12] })
    }).addTo(map).bindTooltip('Makkah Â· Ø§Ù„ÙƒØ¹Ø¨Ø©', { direction:'top', offset:[0,-14] });

    // User marker
    userMarker = L.marker([lat,lng], {
      icon: L.divIcon({ html:'<div class="user-marker"></div>', className:'', iconSize:[14,14], iconAnchor:[7,7] })
    }).addTo(map).bindTooltip('You', { direction:'top', offset:[0,-10] });

    // Great circle Qibla line
    qiblaLine = L.polyline(greatCirclePath(lat, lng, KAABA_LAT, KAABA_LNG), {
      color:'#C9A84C', weight:2.5, opacity:0.85, dashArray:'8 6', lineCap:'round'
    }).addTo(map);

    // Heading direction line (green, shorter, shows where phone is pointing)
    const headingDist = Math.min(calculateDistance(lat, lng) * 0.15, 300);
    const headEnd = destPoint(lat, lng, currentHeading, headingDist);
    headingLine = L.polyline([[lat,lng], headEnd], {
      color:'#2DD4A8', weight:3, opacity:0.7, lineCap:'round'
    }).addTo(map);

    map.fitBounds(L.latLngBounds([[lat,lng],[KAABA_LAT,KAABA_LNG]]), { padding:[35,35] });
  }

  function updateMap(lat, lng) {
    if (!mapInitialized) { initMap(lat, lng); return; }
    userMarker.setLatLng([lat, lng]);
    qiblaLine.setLatLngs(greatCirclePath(lat, lng, KAABA_LAT, KAABA_LNG));
    updateHeadingLine(lat, lng);
  }

  function updateHeadingLine(lat, lng) {
    if (!headingLine) return;
    const headingDist = Math.min(calculateDistance(lat, lng) * 0.15, 300);
    const end = destPoint(lat, lng, currentHeading, Math.max(headingDist, 30));
    headingLine.setLatLngs([[lat, lng], end]);
  }

  // â”€â”€ UI update â”€â”€
  function updateUI() {
    $('compassPlate').style.transform = `rotate(${-currentHeading}deg)`;

    if (qiblaBearing !== null) {
      $('qiblaIndicator').style.transform = `rotate(${qiblaBearing - currentHeading}deg)`;
      $('degreeValue').innerHTML = `${Math.round(qiblaBearing)}<span class="deg-symbol">Â°</span>`;

      let diff = ((qiblaBearing - currentHeading) % 360 + 360) % 360;
      if (diff > 180) diff = 360 - diff;
      const aligned = diff < 5;
      $('alignmentMsg').classList.toggle('visible', aligned);
      $('compassRing').classList.toggle('aligned', aligned);
    }

    if (userLat !== null && mapInitialized) updateHeadingLine(userLat, userLng);
  }

  // â”€â”€ Heading smoothing â”€â”€
  let headingBuf = [];
  function smoothHeading(raw) {
    headingBuf.push(raw);
    if (headingBuf.length > 5) headingBuf.shift();
    let s=0, c=0;
    for (const h of headingBuf) { s += Math.sin(toRad(h)); c += Math.cos(toRad(h)); }
    return (toDeg(Math.atan2(s, c)) + 360) % 360;
  }

  function handleOrientation(e) {
    let heading = e.webkitCompassHeading !== undefined ? e.webkitCompassHeading
                : e.alpha !== null ? (360 - e.alpha) % 360 : null;
    if (heading === null) return;

    if (!compassSupported) {
      compassSupported = true;
      $('statusText').textContent = userLat !== null ? 'Compass active' : 'Waiting for GPSâ€¦';
      $('statusText').classList.remove('loading-pulse');
      $('calibrationHint').classList.add('visible');
      setTimeout(() => $('calibrationHint').classList.remove('visible'), 7000);
    }
    currentHeading = smoothHeading(heading);
    updateUI();
  }

  function onLocationSuccess(pos) {
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
    qiblaBearing = calculateQibla(userLat, userLng);
    const dist = calculateDistance(userLat, userLng);

    $('gpsDot').classList.add('active');
    $('statusText').textContent = compassSupported ? 'Compass active' : 'Waiting for compassâ€¦';
    $('statusText').classList.remove('loading-pulse');
    $('distanceValue').innerHTML = `${dist.toFixed(0)} <small>km</small>`;
    $('bearingValue').textContent = `${qiblaBearing.toFixed(1)}Â°`;
    $('latValue').textContent = userLat.toFixed(4);
    $('lngValue').textContent = userLng.toFixed(4);

    updateMap(userLat, userLng);
    updateUI();
  }

  function onLocationError() {
    $('gpsDot').classList.add('error');
    $('statusText').textContent = 'Location unavailable';
    $('statusText').classList.remove('loading-pulse');
  }

  async function startApp() {
    if ('geolocation' in navigator) {
      navigator.geolocation.watchPosition(onLocationSuccess, onLocationError, {
        enableHighAccuracy: true, maximumAge: 10000, timeout: 15000
      });
    } else { onLocationError(); }

    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const perm = await DeviceOrientationEvent.requestPermission();
        if (perm === 'granted') window.addEventListener('deviceorientation', handleOrientation, true);
        else { $('overlayError').textContent = 'Compass permission denied.'; $('overlayError').style.display = 'block'; return; }
      } catch(e) { $('overlayError').textContent = e.message; $('overlayError').style.display = 'block'; return; }
    } else if ('DeviceOrientationEvent' in window) {
      window.addEventListener('deviceorientation', handleOrientation, true);
      setTimeout(() => {
        if (!compassSupported && qiblaBearing !== null) {
          $('statusText').textContent = 'No compass â€” showing bearing only';
          $('statusText').classList.remove('loading-pulse');
          updateUI();
        }
      }, 3000);
    } else {
      $('statusText').textContent = 'No compass sensor';
      $('statusText').classList.remove('loading-pulse');
    }

    $('overlay').classList.add('hidden');
  }

  $('startBtn').addEventListener('click', startApp);
</script>
</body>
</html>
